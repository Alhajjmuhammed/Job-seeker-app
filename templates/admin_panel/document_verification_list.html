{% extends 'admin_panel/base_admin.html' %}
{% load static %}

{% block title %}Document Reviews - Admin Panel{% endblock %}
{% block page_title %}Document Reviews{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2 class="h4 mb-1">
            <i class="bi bi-file-earmark-check"></i> Document Verification Queue
        </h2>
        <p class="text-muted mb-0">Select a worker to review their documents</p>
    </div>
    <div class="col-md-4 text-end">
        {% if selected_worker %}
        <a href="{% url 'admin_panel:document_verification_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Workers
        </a>
        {% endif %}
    </div>
</div>

<!-- Statistics -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h3 class="text-warning mb-1">{{ pending_count }}</h3>
                <small class="text-muted">Pending Review</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h3 class="text-success mb-1">{{ approved_count }}</h3>
                <small class="text-muted">Approved</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h3 class="text-danger mb-1">{{ rejected_count }}</h3>
                <small class="text-muted">Rejected</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <h3 class="text-info mb-1">{{ total_count }}</h3>
                <small class="text-muted">Total Documents</small>
            </div>
        </div>
    </div>
</div>

{% if not selected_worker %}
<!-- Workers List -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-people"></i> Workers with Documents</h5>
    </div>
    <div class="card-body">
        {% if workers_with_docs %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Worker</th>
                        <th>Email</th>
                        <th>Total Documents</th>
                        <th>Pending</th>
                        <th>Approved</th>
                        <th>Rejected</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for worker in workers_with_docs %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if worker.profile_image %}
                                <img src="{{ worker.profile_image.url }}" 
                                     alt="{{ worker.user.get_full_name }}" 
                                     class="rounded-circle me-3" 
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                {% else %}
                                <div class="bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
                                     style="width: 40px; height: 40px;">
                                    <i class="bi bi-person"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ worker.user.get_full_name }}</div>
                                    <small class="text-muted">@{{ worker.user.username }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ worker.user.email }}</td>
                        <td><span class="badge bg-info">{{ worker.total_docs }}</span></td>
                        <td><span class="badge bg-warning">{{ worker.pending_docs }}</span></td>
                        <td><span class="badge bg-success">{{ worker.approved_docs }}</span></td>
                        <td><span class="badge bg-danger">{{ worker.rejected_docs }}</span></td>
                        <td class="text-end">
                            <a href="?worker={{ worker.id }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-folder-open"></i> View Documents
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox fs-1 text-muted"></i>
            <p class="text-muted mt-3">No workers with documents found</p>
        </div>
        {% endif %}
    </div>
</div>

{% else %}
<!-- Selected Worker's Documents -->
<div class="alert alert-info mb-4">
    <div class="d-flex align-items-center">
        {% if selected_worker.profile_image %}
        <img src="{{ selected_worker.profile_image.url }}" 
             alt="{{ selected_worker.user.get_full_name }}" 
             class="rounded-circle me-3" 
             style="width: 50px; height: 50px; object-fit: cover;">
        {% else %}
        <div class="bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
             style="width: 50px; height: 50px;">
            <i class="bi bi-person fs-4"></i>
        </div>
        {% endif %}
        <div>
            <h5 class="mb-0">{{ selected_worker.user.get_full_name }}</h5>
            <small class="text-muted">@{{ selected_worker.user.username }} â€¢ {{ selected_worker.user.email }}</small>
        </div>
        <div class="ms-auto">
            <span class="badge bg-primary">{{ documents.count }} document{% if documents.count != 1 %}s{% endif %}</span>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body">
        {% if documents %}
        <div class="row g-3">
            {% for doc in documents %}
            <div class="col-12">
                <div class="card border-2 {% if doc.verification_status == 'pending' %}border-warning{% elif doc.verification_status == 'approved' %}border-success{% elif doc.verification_status == 'rejected' %}border-danger{% endif %} shadow-sm">
                    <div class="card-header bg-light border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 fw-bold">{{ doc.worker.user.get_full_name }}</h6>
                                <small class="text-muted">@{{ doc.worker.user.username }}</small>
                            </div>
                            {% if doc.verification_status == 'pending' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Pending</span>
                            {% elif doc.verification_status == 'approved' %}
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Approved</span>
                            {% elif doc.verification_status == 'rejected' %}
                            <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Rejected</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3 mb-3 mb-md-0">
                                <small class="text-muted d-block mb-1">Document Type</small>
                                <p class="mb-0 fw-bold">
                                    {% if doc.document_type == 'cv' %}
                                    <i class="bi bi-file-earmark-text text-primary"></i> CV/Resume
                                    {% elif doc.document_type == 'id' %}
                                    <i class="bi bi-card-text text-info"></i> ID Card
                                    {% elif doc.document_type == 'certificate' %}
                                    <i class="bi bi-award text-warning"></i> Certificate
                                    {% elif doc.document_type == 'license' %}
                                    <i class="bi bi-patch-check text-success"></i> License
                                    {% else %}
                                    <i class="bi bi-file-earmark"></i> Other
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <small class="text-muted d-block mb-1">Uploaded</small>
                                <p class="mb-0">{{ doc.uploaded_at|date:"M d, Y" }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex gap-2">
                                    <a href="{{ doc.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm flex-fill">
                                        <i class="bi bi-download"></i> View/Download
                                    </a>
                                    {% if doc.verification_status == 'pending' %}
                                    <button type="button" class="btn btn-success btn-sm flex-fill" data-bs-toggle="modal" 
                                            data-bs-target="#approveModal{{ doc.id }}">
                                        <i class="bi bi-check-lg"></i> Approve
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm flex-fill" data-bs-toggle="modal" 
                                            data-bs-target="#rejectModal{{ doc.id }}">
                                        <i class="bi bi-x-lg"></i> Reject
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {% if doc.title %}
                        <div class="mt-3">
                            <small class="text-muted d-block mb-1">Title</small>
                            <p class="mb-0">{{ doc.title }}</p>
                        </div>
                        {% endif %}
                        
                        {% if doc.verification_status == 'rejected' and doc.rejection_reason %}
                        <div class="alert alert-danger mt-3 mb-0">
                            <small><strong><i class="bi bi-exclamation-triangle"></i> Rejection Reason:</strong></small>
                            <p class="mb-0 small mt-1">{{ doc.rejection_reason }}</p>
                        </div>
                        {% elif doc.verification_notes %}
                        <div class="alert alert-info mt-3 mb-0">
                            <small><strong><i class="bi bi-info-circle"></i> Admin Notes:</strong></small>
                            <p class="mb-0 small mt-1">{{ doc.verification_notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Approve Modal -->
            <div class="modal fade" id="approveModal{{ doc.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'admin_panel:verify_document' doc.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="approve">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Approve Document</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Approve document from <strong>{{ doc.worker.user.get_full_name }}</strong>?</p>
                                <div class="mb-3">
                                    <label for="notes{{ doc.id }}" class="form-label">Notes (optional)</label>
                                    <textarea class="form-control" id="notes{{ doc.id }}" name="notes" rows="2" 
                                              placeholder="Add any verification notes..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-lg"></i> Approve Document
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Reject Modal -->
            <div class="modal fade" id="rejectModal{{ doc.id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="post" action="{% url 'admin_panel:verify_document' doc.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="reject">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title"><i class="bi bi-x-circle"></i> Reject Document</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Reject document from <strong>{{ doc.worker.user.get_full_name }}</strong>?</p>
                                <div class="mb-3">
                                    <label for="reject_reason{{ doc.id }}" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="reject_reason{{ doc.id }}" name="reason" rows="3" 
                                              placeholder="Explain why this document is being rejected..." required></textarea>
                                    <small class="text-muted">This will be visible to the worker</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">
                                    <i class="bi bi-x-lg"></i> Reject Document
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox fs-1 text-muted"></i>
            <p class="text-muted mt-3">No documents found for this worker</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Worker Verification Section -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-person-check"></i> Worker Verification</h5>
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex align-items-center">
                    {% if selected_worker.profile_image %}
                    <img src="{{ selected_worker.profile_image.url }}" 
                         alt="{{ selected_worker.user.get_full_name }}" 
                         class="rounded-circle me-3" 
                         style="width: 60px; height: 60px; object-fit: cover;">
                    {% else %}
                    <div class="bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" 
                         style="width: 60px; height: 60px;">
                        <i class="bi bi-person fs-4"></i>
                    </div>
                    {% endif %}
                    <div>
                        <h5 class="mb-1">{{ selected_worker.user.get_full_name }}</h5>
                        <p class="mb-0 text-muted">@{{ selected_worker.user.username }}</p>
                        <div class="mt-1">
                            {% if selected_worker.verification_status == 'verified' %}
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verified</span>
                            {% elif selected_worker.verification_status == 'pending' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Pending Verification</span>
                            {% elif selected_worker.verification_status == 'rejected' %}
                            <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Rejected</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                {% if selected_worker.verification_status != 'verified' %}
                <form method="post" action="{% url 'admin_panel:verify_worker' selected_worker.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="verify">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle"></i> Verify Worker
                    </button>
                </form>
                {% endif %}
                {% if selected_worker.verification_status != 'rejected' %}
                <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" 
                        data-bs-target="#rejectWorkerModal">
                    <i class="bi bi-x-circle"></i> Reject Worker
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="mt-3 pt-3 border-top">
            <div class="row">
                <div class="col-md-3">
                    <small class="text-muted d-block">Email</small>
                    <p class="mb-2">{{ selected_worker.user.email }}</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Phone</small>
                    <p class="mb-2">{{ selected_worker.user.phone_number|default:"-" }}</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Experience</small>
                    <p class="mb-2">{{ selected_worker.experience_years }} years</p>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Profile Completion</small>
                    <p class="mb-2">{{ selected_worker.profile_completion }}%</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Worker Modal -->
<div class="modal fade" id="rejectWorkerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'admin_panel:verify_worker' selected_worker.id %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-x-circle"></i> Reject Worker</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to reject <strong>{{ selected_worker.user.get_full_name }}</strong>?</p>
                    <div class="mb-3">
                        <label for="reject_reason" class="form-label">Rejection Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reject_reason" name="reason" rows="3" 
                                  placeholder="Explain why this worker is being rejected..." required></textarea>
                        <small class="text-muted">This will be visible to the worker</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-lg"></i> Reject Worker
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
