{% extends 'admin_panel/base_admin.html' %}
{% load static %}

{% block page_title %}Manage Jobs{% endblock %}

{% block extra_css %}
<style>
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #0eb8a6;
    }
    
    .stat-card.warning {
        border-left-color: #f59e0b;
    }
    
    .stat-card.info {
        border-left-color: #3b82f6;
    }
    
    .stat-card.success {
        border-left-color: #10b981;
    }
    
    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        color: #0f766e;
    }
    
    .stat-card p {
        margin: 0;
        color: #6b7280;
        font-size: 0.9rem;
    }
    
    .filters-section {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        margin-bottom: 1rem;
    }
    
    .job-card {
        background: white;
        border-radius: 8px;
        padding: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
        border-left: 3px solid #e5e7eb;
    }
    
    .job-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left-color: #0eb8a6;
    }
    
    .job-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .job-title {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        line-height: 1.2;
    }
    
    .job-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        color: #6b7280;
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
    }
    
    .job-meta-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }
    
    .worker-need-info .remaining {
        color: #dc2626;
        font-weight: 600;
    }
    
    .worker-need-info .completed-staff {
        color: #059669;
        font-weight: 600;
    }
    
    .job-description {
        color: #4b5563;
        margin-bottom: 0.5rem;
        line-height: 1.4;
        font-size: 0.85rem;
    }
    
    .job-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .badge-open {
        background: #dcfce7;
        color: #166534;
    }
    
    .badge-in-progress {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .badge-completed {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-cancelled {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .assigned-worker {
        background: #f0fdf4;
        border: 1px solid #86efac;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .assigned-worker-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .worker-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #0eb8a6;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .btn-primary {
        background: #0eb8a6;
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.8rem;
    }
    
    .btn-primary:hover {
        background: #0d9488;
        color: white;
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.8rem;
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
        color: #374151;
    }
    
    .btn-secondary.disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.7;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    
    .pagination a, .pagination span {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        color: #374151;
        background: white;
        border: 1px solid #d1d5db;
    }
    
    .pagination a:hover {
        background: #f3f4f6;
    }
    
    .pagination .current {
        background: #0eb8a6;
        color: white;
        border-color: #0eb8a6;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .form-control {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.95rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #0eb8a6;
        box-shadow: 0 0 0 3px rgba(14, 184, 166, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title mb-2">Job Management</h1>
            <p class="text-muted">Manage jobs and assign workers</p>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3>{{ total_jobs }}</h3>
            <p><i class="bi bi-briefcase"></i> Total Jobs</p>
        </div>
        <div class="stat-card warning">
            <h3>{{ open_jobs }}</h3>
            <p><i class="bi bi-hourglass-split"></i> Open Jobs</p>
        </div>
        <div class="stat-card info">
            <h3>{{ assigned_jobs }}</h3>
            <p><i class="bi bi-person-check"></i> Assigned Jobs</p>
        </div>
        <div class="stat-card success">
            <h3>{{ completed_jobs }}</h3>
            <p><i class="bi bi-check-circle"></i> Completed Jobs</p>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-section">
        <form method="get" action="{% url 'admin_panel:job_management' %}">
            <div class="filter-row">
                <div class="form-group">
                    <label for="status">Status</label>
                    <select name="status" id="status" class="form-control">
                        <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Statuses</option>
                        <option value="open" {% if current_status == 'open' %}selected{% endif %}>Open</option>
                        <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if current_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category">Category</label>
                    <select name="category" id="category" class="form-control">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if current_category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="search">Search</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="Search by title, client..." value="{{ search }}">
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="bi bi-search"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Jobs List -->
    <div class="jobs-list">
        {% for job in jobs_page %}
        <div class="job-card">
            <div class="job-header">
                <div>
                    <h2 class="job-title">{{ job.title }}</h2>
                    <div class="job-meta">
                        <span class="job-meta-item">
                            <i class="bi bi-person"></i>
                            {{ job.client.get_full_name }}
                        </span>
                        <span class="job-meta-item">
                            <i class="bi bi-tag"></i>
                            {{ job.category.name|default:"No Category" }}
                        </span>
                        <span class="job-meta-item">
                            <i class="bi bi-geo-alt"></i>
                            {{ job.city }}
                        </span>
                        <span class="job-meta-item">
                            <i class="bi bi-currency-dollar"></i>
                            ${{ job.budget|floatformat:0 }}
                        </span>
                        <span class="job-meta-item worker-need-info">
                            <i class="bi bi-people"></i>
                            {% if job.is_fully_staffed %}
                                <span class="completed-staff">All workers assigned</span>
                            {% else %}
                                {{ job.workers_remaining }} needed
                            {% endif %}
                        </span>
                        <span class="job-meta-item">
                            <i class="bi bi-calendar"></i>
                            {{ job.created_at|date:"M d, Y" }}
                        </span>
                    </div>
                </div>
                <div>
                    {% if job.status == 'open' %}
                    <span class="badge badge-open">Open</span>
                    {% elif job.status == 'in_progress' %}
                    <span class="badge badge-in-progress">In Progress</span>
                    {% elif job.status == 'completed' %}
                    <span class="badge badge-completed">Completed</span>
                    {% else %}
                    <span class="badge badge-cancelled">Cancelled</span>
                    {% endif %}
                </div>
            </div>
            
            <p class="job-description">
                {{ job.description|truncatewords:30 }}
            </p>
            
            {% if job.assigned_workers.exists %}
            <div class="workers-inline">
                <strong class="workers-count">{{ job.assigned_workers.count }}/{{ job.workers_needed }}</strong>
                {% for worker in job.assigned_workers.all|slice:":4" %}
                <span class="worker-mini" title="{{ worker.user.get_full_name }} - {{ worker.average_rating|floatformat:1 }}★">
                    {{ worker.user.first_name.0 }}{{ worker.user.last_name.0 }}
                </span>
                {% endfor %}
                {% if job.assigned_workers.count > 4 %}
                <span class="worker-mini more">+{{ job.assigned_workers.count|add:-4 }}</span>
                {% endif %}
                <button type="button" class="expand-workers" data-bs-toggle="collapse" 
                        data-bs-target="#workers-{{ job.id }}" title="Manage Workers">
                    <i class="bi bi-three-dots"></i>
                </button>
                <div class="collapse" id="workers-{{ job.id }}">
                    <div class="workers-manage">
                        {% for worker in job.assigned_workers.all %}
                        <div class="worker-row">
                            <span>{{ worker.user.get_full_name }}</span>
                            <span class="rating">{{ worker.average_rating|floatformat:1 }}★</span>
                            <form method="post" action="{% url 'admin_panel:assign_worker' job.id %}" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="unassign">
                                <input type="hidden" name="worker_id" value="{{ worker.id }}">
                                <button type="submit" class="remove-btn" title="Remove Worker">×</button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="job-actions">
                <a href="{% url 'jobs:job_detail' job.id %}" class="btn-secondary">
                    <i class="bi bi-eye"></i> View Details
                </a>
                
                {% if not job.is_fully_staffed %}
                <a href="{% url 'admin_panel:assign_worker' job.id %}" class="btn-primary">
                    <i class="bi bi-person-plus"></i> 
                    {% if job.assigned_workers.count == 0 %}
                        Assign Worker ({{ job.workers_needed }} needed)
                    {% else %}
                        Assign {{ job.workers_remaining }} More
                    {% endif %}
                </a>
                {% else %}
                <span class="btn-secondary disabled">
                    <i class="bi bi-check-circle"></i> Fully Staffed
                </span>
                {% endif %}
                
                <a href="{% url 'jobs:conversation' job.client.id %}" class="btn-secondary">
                    <i class="bi bi-chat-dots"></i> Message Client
                </a>
            </div>
        </div>
        {% empty %}
        <div class="job-card text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #d1d5db;"></i>
            <p class="mt-3 text-muted">No jobs found matching your filters.</p>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if jobs_page.has_other_pages %}
    <div class="pagination">
        {% if jobs_page.has_previous %}
        <a href="?page=1{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if search %}&search={{ search }}{% endif %}">First</a>
        <a href="?page={{ jobs_page.previous_page_number }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if search %}&search={{ search }}{% endif %}">Previous</a>
        {% endif %}
        
        <span class="current">Page {{ jobs_page.number }} of {{ jobs_page.paginator.num_pages }}</span>
        
        {% if jobs_page.has_next %}
        <a href="?page={{ jobs_page.next_page_number }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if search %}&search={{ search }}{% endif %}">Next</a>
        <a href="?page={{ jobs_page.paginator.num_pages }}{% if current_status != 'all' %}&status={{ current_status }}{% endif %}{% if current_category %}&category={{ current_category }}{% endif %}{% if search %}&search={{ search }}{% endif %}">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
